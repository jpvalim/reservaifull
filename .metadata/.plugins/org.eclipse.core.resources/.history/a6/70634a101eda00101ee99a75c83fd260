package com.jpv.reservai.services;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.jpv.reservai.entities.Usuario;
import com.jpv.reservai.repositories.AtendenteRepository;
import com.jpv.reservai.repositories.ClienteRepository;
import com.jpv.reservai.repositories.FornecedorRepository;

@Service
public class HttpUserDetailsService implements UserDetailsService {

    private final ClienteRepository clienteRepository;
    private final FornecedorRepository fornecedorRepository;
    private final AtendenteRepository atendenteRepository;


    public HttpUserDetailsService(final ClienteRepository clienteRepository, FornecedorRepository fornecedorRepo, AtendenteRepository atendenteRepo, PasswordEncoder passwordEncoder) {
        this.clienteRepository = clienteRepository;
        this.fornecedorRepository = fornecedorRepo;
        this.atendenteRepository = atendenteRepo;
      
    }

	@Override
	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
		Usuario user = clienteRepository.findByEmailIgnoreCase(username);
	
		
		if (user == null) {
			user = fornecedorRepository.findByEmailIgnoreCase(username);
			if(user == null) {
				user = atendenteRepository.findByEmailIgnoreCase(username);
			}
        }
		
		if (user == null) {
			 //log.warn("user not found: {}", username);
            throw new UsernameNotFoundException("User " + username + " not found");
		}
	
		
        final List<SimpleGrantedAuthority> roles = user.getPerfis().stream().map(x -> new SimpleGrantedAuthority(x.getDescricao())).collect(Collectors.toList());;
        
        return User.builder()
                .username(username)
                .password(user.getPassword())
                .accountExpired(false) // Pode ajustar conforme necess치rio
                .accountLocked(false)   // Pode ajustar conforme necess치rio
                .credentialsExpired(false) // Pode ajustar conforme necess치rio
                .disabled(false) // Pode ajustar conforme necess치rio
                .authorities(roles)
                .build();
    }
	        

}
